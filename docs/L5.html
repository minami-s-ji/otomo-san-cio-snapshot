<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Otomosan Snapshot</title>
    <style>
      body {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        padding: 16px;
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        line-height: 1.5;
      }
      .meta {
        color: #666;
        font-size: 12px;
        margin-bottom: 12px;
      }
    </style>
  </head>
  <body>
    <div class="meta">generated by GitHub Actions</div>
    <pre id="content">L5｜失敗・落とし穴・代替案ナレッジ（抽出済・確定）
最終更新日時
2025-12-18 14:06
（このページの運用ルール）
この L5 は Notion 上で「L5ページ丸ごと置換」で更新する前提とする
貼り付け後の手動整形（見出し化・UI操作）を前提にしない
Markdown 記法（# / ## / ``` 等）に依存しない
このL5の定義（重要）
このページは、
おともさん経営アシスタントAI開発において
「期待した設計に対して
実際の挙動がどう違ったか」
を 事実ベースで記録する技術ログ
このナレッジの位置づけ（固定）
このL5は「失敗集」ではない
Dify / スマレジAPI / LLM の
実際の挙動を前提に設計判断を行うための一次情報
運用ルール
新しい知見が出た場合は、必ず既存ケースの下に追記する
「似たが同じでない挙動」は別ケースとして分ける
未解決でも記録する（未解決は立派な情報）
L3（正解ルート）を変更した場合は、
その理由が L5 に存在する状態を作る
ケース1｜Dify：LLMノードは「Systemで禁止」してもJSONを壊す
分類
LLM挙動
Dify × LLM
対象
Dify Workflow
LLMノード（gpt-4o-mini）
商品マスタ自動生成WF
期待していた挙動
Systemで
「JSON以外出力禁止」
「コードブロック禁止」
を明示すれば、常に valid JSON が返る
実際の挙動
以下の条件で JSON が壊れる可能性があることを確認・懸念
System内に JSON例＋日本語コメントが混在
カッコ書き（注釈）がJSONの一部として誤解される
モデル・文脈長によって再現率が変わる
技術的原因の推定
LLMは「例」を優先的に模倣する
厳密な構文より自然言語の流れを優先する
回避策（未実装）
JSON例を完全排除し、文章制約のみにする
もしくは後段で JSON.parse 前提の検証・修復ノードを置く
ケース2｜Dify：イテレーション×LLMで「微妙に出力が揺れる」
分類
Dify挙動
LLM挙動
対象
Dify イテレーションノード
商品マスタ生成WF
期待していた挙動
同一行入力 → 同一JSON出力
実際の挙動
大枠は同じだが、
表現
語尾
自信度スコア
が微妙に揺れる可能性
技術的原因
temperature=0 でも完全決定論ではない
Dify内部での再実行・分割処理の影響
設計上の含意
完全一致を前提にしない
「後段で上書き・昇格」前提の設計は妥当
ケース3｜スマレジ Platform API：権限は二重に必要
分類
スマレジAPI挙動
対象
スマレジ Platform API
OAuth2 Client Credentials
期待していた挙動
トークン取得時に scope を指定すれば、その権限でAPIが使える
実際の挙動
以下 両方 が必要
スマレジ管理画面の「アプリ設定」で権限付与
トークン取得時の scope 指定
どちらかが欠けると 403 / 空レスポンス
技術的原因
スマレジ側の権限モデルが
アプリ設定
トークン
の AND 条件になっている
教訓
トークン取得WFは
「一度作って終わり」ではなく、権限確認ログを残すべき
ケース4｜スマレジAPI：日付指定なしは「想定以上に重い」
分類
スマレジAPI挙動
対象
取引履歴API
日次サマリWF
期待していた挙動
日付を指定しなくても
最近のデータが返る想定
実際の挙動
日付指定なし／範囲が広いと
レスポンスが重い
タイムアウトリスク
不要データが大量に返る
設計上の含意
日次サマリWFでは必ず日付を明示的に指定
バッチ前提で設計するのが安全
ケース5｜LLM：件数制御は「文章」では効かない
分類
LLM挙動
対象
仮説系配列フィールド
商品マスタJSON
期待していた挙動
「最大1件」「確からしさは低」と書けば守られる
実際の挙動
モデルによっては
2〜3件出力
説明文が伸びる
技術的原因
LLMは件数制御が苦手
数値制約は弱い
回避策（予定）
配列を後段で truncate
もしくは構造を「単一オブジェクト」に変更
ケース6｜LLM：「重要制約」は一重ロックだと破られる
分類
LLM挙動
対象
"カテゴリ": "不明" 固定ルール
期待していた挙動
Systemで禁止すれば常に守られる
実際の挙動
モデル変更・文脈変化時に破られる可能性を認識
技術的含意
重要制約は必ず二重ロック
プロンプト
後段処理
ケース7｜Dify：テンプレ・ノード再利用で「意図しない設定引き継ぎ」
分類
Dify挙動
対象
Workflow複製
LLMノード設定
期待していた挙動
ノードをコピーしても
必要な設定だけ引き継がれる
実際の挙動
temperature / model / system が
意図せず引き継がれる可能性
教訓
重要ノードは
新規作成 or 設定レビュー必須</pre>
  </body>
</html>
